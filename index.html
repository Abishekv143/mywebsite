<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Meteor Impact on Mars</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; }
  </style>
</head>
<body>
  <!-- Three.js -->
  <script src="https://cdn.jsdelivr.net/npm/three@0.150.0/build/three.min.js"></script>
  <!-- Cannon.js -->
  <script src="https://cdn.jsdelivr.net/npm/cannon@0.6.2/build/cannon.min.js"></script>

  <script>
    // THREE.js setup
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    const renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    // Lighting
    const light = new THREE.PointLight(0xffffff, 1.5, 100);
    light.position.set(10, 10, 10);
    scene.add(light);
    scene.add(new THREE.AmbientLight(0x404040));

    // CANNON.js world
    const world = new CANNON.World();
    world.gravity.set(0, -9.82, 0);

    // Mars planet
    const planetRadius = 3;
    const marsTexture = new THREE.TextureLoader().load("https://threejsfundamentals.org/threejs/resources/images/mars_1k_color.jpg");
    const planetGeometry = new THREE.SphereGeometry(planetRadius, 64, 64);
    const planetMaterial = new THREE.MeshPhongMaterial({ map: marsTexture });
    const planetMesh = new THREE.Mesh(planetGeometry, planetMaterial);
    scene.add(planetMesh);

    const planetBody = new CANNON.Body({
      mass: 0,
      shape: new CANNON.Sphere(planetRadius)
    });
    world.addBody(planetBody);

    // Meteor
    const meteorGeometry = new THREE.SphereGeometry(0.3, 16, 16);
    const meteorMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
    const meteorMesh = new THREE.Mesh(meteorGeometry, meteorMaterial);
    scene.add(meteorMesh);

    const meteorBody = new CANNON.Body({
      mass: 1,
      shape: new CANNON.Sphere(0.3),
      position: new CANNON.Vec3(0, 6, 0)
    });
    world.addBody(meteorBody);

    // Debris chunks
    const chunks = [];
    function spawnChunks(position) {
      for (let i = 0; i < 25; i++) {
        const size = Math.random() * 0.25;
        const geom = new THREE.BoxGeometry(size, size, size);
        const mat = new THREE.MeshPhongMaterial({ color: 0x882200 });
        const mesh = new THREE.Mesh(geom, mat);
        scene.add(mesh);

        const body = new CANNON.Body({
          mass: 0.2,
          shape: new CANNON.Box(new CANNON.Vec3(size/2, size/2, size/2)),
          position: new CANNON.Vec3(position.x, position.y, position.z)
        });

        body.velocity.set(
          (Math.random() - 0.5) * 12,
          Math.random() * 12,
          (Math.random() - 0.5) * 12
        );

        world.addBody(body);
        chunks.push({ mesh, body });
      }
    }

    // Starfield background
    function addStars() {
      const starGeometry = new THREE.BufferGeometry();
      const starCount = 2000;
      const positions = [];
      for (let i = 0; i < starCount; i++) {
        const x = (Math.random() - 0.5) * 2000;
        const y = (Math.random() - 0.5) * 2000;
        const z = (Math.random() - 0.5) * 2000;
        positions.push(x, y, z);
      }
      starGeometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
      const starMaterial = new THREE.PointsMaterial({ color: 0xffffff, size: 1 });
      const stars = new THREE.Points(starGeometry, starMaterial);
      scene.add(stars);
    }
    addStars();

    // Explosion effect
    let explosionLight;
    function createExplosion(position) {
      explosionLight = new THREE.PointLight(0xffaa33, 5, 20);
      explosionLight.position.copy(position);
      scene.add(explosionLight);

      // Shrinking flash
      let intensity = 5;
      const interval = setInterval(() => {
        intensity -= 0.2;
        explosionLight.intensity = intensity;
        if (intensity <= 0) {
          scene.remove(explosionLight);
          clearInterval(interval);
        }
      }, 100);
    }

    // Crater effect (dark circle on Mars)
    function addCrater(position) {
      const craterGeometry = new THREE.CircleGeometry(0.8, 32);
      const craterMaterial = new THREE.MeshBasicMaterial({ color: 0x111111 });
      const craterMesh = new THREE.Mesh(craterGeometry, craterMaterial);

      // Place on Mars surface
      craterMesh.position.copy(position.clone().normalize().multiplyScalar(planetRadius + 0.01));
      craterMesh.lookAt(planetMesh.position);
      scene.add(craterMesh);
    }

    // Camera
    camera.position.z = 12;

    // Animation
    let impactHappened = false;
    function animate() {
      requestAnimationFrame(animate);

      world.step(1/60);

      meteorMesh.position.copy(meteorBody.position);
      meteorMesh.quaternion.copy(meteorBody.quaternion);

      chunks.forEach(obj => {
        obj.mesh.position.copy(obj.body.position);
        obj.mesh.quaternion.copy(obj.body.quaternion);
      });

      // Detect impact
      if (!impactHappened && meteorBody.position.y <= planetRadius + 0.3) {
        impactHappened = true;
        spawnChunks(meteorBody.position);
        createExplosion(meteorBody.position);
        addCrater(meteorBody.position);
        scene.remove(meteorMesh);
        world.remove(meteorBody);
      }

      renderer.render(scene, camera);
    }
    animate();

    // Resize
    window.addEventListener("resize", () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });
  </script>
</body>
</html>
